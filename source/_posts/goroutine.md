---
title: goroutineã€channel
publish: true
description: è®°å½•ä¸€äº›æœ‰å…³goroutineçš„çŸ¥è¯†ç‚¹
date: 2024-09-27
tags:
  - Golang
---

# goroutine

goroutineæ˜¯Goè¯­è¨€ä¸­çš„è½»é‡çº§çº¿ç¨‹çš„å®ç°ï¼Œç”±**Goè¿è¡Œæ—¶ç®¡ç†**ï¼Œæ˜¯Goç¨‹åºä¸­æœ€å°çš„å¹¶å‘æ‰§è¡Œå•ä½ã€‚å¹¶ä¸”ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„åç¨‹æ˜¯ä¸æ”¯æŒå¹¶å‘çš„ï¼Œè€Œ**goroutineæ”¯æŒå¹¶å‘**ï¼ŒåŒæ—¶goroutineå¯ä»¥è¿è¡Œåœ¨ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ä¸Š

**goroutineå¤§å°ä¸º2kbï¼Œå¯ä»¥åŠ¨æ€å¢å¤§**

## ç®€è¿°

### goroutineçš„è¿è¡Œæœºåˆ¶

åœ¨Goç¨‹åºä¸­ï¼Œ`main`å‡½æ•°æ˜¯ç¨‹åºçš„å…¥å£ï¼Œå½“ç¨‹åºå¼€å§‹æ‰§è¡Œ`main`å‡½æ•°æ—¶ï¼Œå°±ä¼šåˆ›å»ºä¸€ä¸ª**ä¸»goroutine**ï¼Œè¿™ä¸ªä¸»goroutineæ˜¯**å…¨å±€å”¯ä¸€çš„**å¹¶ä¸”ä»£è¡¨ç€æ•´ä¸ªGoç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸ

åœ¨ä»£ç ä¸­ï¼Œå¯ä»¥ä½¿ç”¨`go`å…³é”®å­—è½»æ¾åˆ›å»ºå‡ºä¸€ä¸ªgoroutine

ğŸŒ°ï¼š

```go
func sum(a, b int) {
    println(a+b)
}

func main() {
    go sum(1, 2)
}
```

åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œ**`go`å…³é”®å­—+å‡½æ•°è°ƒç”¨**è¡¨ç¤ºåˆ›å»ºä¸€ä¸ªgoroutineå¹¶åœ¨è¿™ä¸ªgoroutineä¸­è¿è¡Œ`sum`å‡½æ•°ã€‚ä½†ä¸Šè¿°ä»£ç çš„è¿è¡Œç»“æœå¹¶ä¸ä¼šç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸï¼Œè¿™æ˜¯å› ä¸º**goroutineçš„è¿è¡Œæœºåˆ¶æ˜¯ï¼šåœ¨ä¸»Goroutineç»“æŸä¹‹åï¼Œå…¶ä»–æ‰€æœ‰çš„goroutineéƒ½ä¼šç›´æ¥é€€å‡º**ï¼Œä¸Šè¿°ä»£ç ä¸­çš„ä¸»goroutineç»“æŸçš„æ¯”å­goroutineæ›´å¿«ï¼Œæ‰€ä»¥æ§åˆ¶å°ä¼šæ²¡æœ‰ä»»ä½•è¾“å‡ºğŸ˜‚

### goroutineçš„ç‰¹ç‚¹

- æ˜¯ä¸€ç§è½»é‡çº§â€œçº¿ç¨‹â€ï¼Œç±»ä¼¼äºåç¨‹
- **éæŠ¢å å¼ï¼ˆå³ä¸ä¼šè¢«ä¸­æ–­ï¼‰å¤šä»»åŠ¡å¤„ç†ï¼Œæœ‰åç¨‹ä¸»åŠ¨äº¤å‡ºè¿è¡ŒæƒåŠ›**
- ç¼–è¯‘å™¨/è§£é‡Šå™¨/è™šæ‹Ÿæœºå±‚é¢çš„å¤šä»»åŠ¡ï¼ˆä¸æ‡‚ğŸ™ƒï¼‰
- å¤šä¸ªåç¨‹å¯ä»¥åœ¨ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ä¸Šè¿è¡Œ

ç”±äºgoroutineæ˜¯éæŠ¢å å¼çš„ï¼Œä¸€ä¸ªgoroutineå¯èƒ½ä¼šåœ¨ä¸€ä¸‹æ—¶æœºä¸»åŠ¨äº¤å‡ºè¿è¡ŒæƒåŠ›

- I/Oï¼Œselect
- channel
- ç­‰å¾…é”
- å‡½æ•°è°ƒç”¨
- runtime.Gosched()

### WaitGroupï¼šå¤šä¸ªgoroutineå¹¶å‘æ‰§è¡Œ

å‰æ–‡é˜è¿°äº†å½“ä¸»goroutineç»“æŸä¹‹åï¼Œå…¶ä»–çš„goroutineéƒ½ä¼šè¢«å¼ºåˆ¶ç»“æŸã€‚ä½†æ˜¯å¾ˆå¤šæƒ…å†µä¸‹ï¼Œä¸»goroutineéœ€è¦åœ¨å…¶ä»–goroutineç»“æŸä¹‹åå†ç»“æŸï¼Œä¸€ç§å¾ˆç®€å•çš„æ–¹æ³•å°±æ˜¯è®©ä¸»goroutineç¡å‡ ç§’

```go
time.Sleep(time.Second)
```

å¦ä¸€ç§æ›´ä¼˜é›…çš„æ–¹æ³•å°±æ˜¯ä½¿ç”¨`sync.WaitGroup`ç»“æ„ä½“ï¼Œå®ç°å¤šä¸ªgoroutineçš„åŒæ­¥

`sync.WaitGroup`ç»“æ„ä½“æœ‰ä¸‰ä¸ªæ–¹æ³•

- `Add(delta)`ï¼šå‘å†…éƒ¨è®¡æ•°å™¨ä¸­æ·»åŠ å¢é‡`delta`ï¼Œå…¶ä¸­`delta`å¯æ­£å¯è´Ÿ
  - ä¸€èˆ¬åœ¨å¯åŠ¨goroutineä¹‹å‰è°ƒç”¨
- `Done()`ï¼šä½¿å†…éƒ¨è®¡æ•°å™¨`-1`ï¼Œç›¸å½“äº`Add(-1)`
  - ä¸€èˆ¬åœ¨goroutineå³å°†ç»“æŸæ—¶æ‰§è¡Œï¼Œå¯é…åˆ`defer`å…³é”®å­—å…±åŒä½¿ç”¨
- `Wait()`ï¼šé˜»å¡å½“å‰goroutineç›´è‡³å†…éƒ¨è®¡æ•°å™¨å‡å°‘è‡³0

âš ï¸ï¼šè°ƒç”¨`Wait()` å‡½æ•°å¯èƒ½å¯¼è‡´æ­»é”ï¼Œé€ æˆç¨‹åºå´©æºƒ

## Goå¹¶å‘çš„å®ç°åŸç†

> DO NOT COMMUNICATE BY SHARING MEMORY; INSTEAD, SHARE MEMORY BY COMMUNICATING. 

åœ¨Goä¸­æœ‰ä¸¤ç§å¹¶å‘å½¢å¼ï¼šä¼ ç»Ÿå…±äº«å†…å­˜çš„æ–¹å¼å’ŒCSPï¼ˆ`communicating sequential processes`ï¼‰å¹¶å‘æ¨¡å‹

### å…±äº«å†…å­˜

åœ¨å¤šä¸ªçº¿ç¨‹å…±äº«å†…å­˜ä»¥å…±äº«æ•°æ®çš„æ¨¡å¼ä¸‹ï¼Œé€šè¿‡**åŠ é”**å®ç°å¹¶å‘å®‰å…¨

åœ¨Goä¸­æœ‰ä¸¤ç§é”ï¼š**äº’æ–¥é”ï¼ˆMutexï¼‰**ã€**è¯»å†™é”ï¼ˆRWMutexï¼‰**

ä¸¤ç§é”çš„ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

```go
// Mutex
	var mux sync.Mutex
	mux.Lock()
	// do something
	mux.Unlock()

// RWMutx
	var mux sync.RWMutex
	mux.RLock()
	// å…è®¸å¤šä¸ªè¯»è€…
	mux.RUnlock()
	mux.Lock()
	// åªæœ‰ä¸€ä¸ªå†™è€…
	mux.Unlock()
```

åŒºåˆ«ï¼šåªæœ‰ä¸€ä¸ªgoroutineèƒ½æ‹¿åˆ°**äº’æ–¥é”**ï¼Œå…¶ä»–goroutineåˆ™ä¼šè¢«é˜»å¡ï¼›å…è®¸æœ‰å¤šä¸ªgoroutineæ‹¿åˆ°**è¯»é”**ï¼Œè€Œåªæœ‰ä¸€ä¸ªgoroutineèƒ½æ‹¿åˆ°**å†™é”**

âš ï¸ï¼šå¦‚æœå°†å¸¦æœ‰é”ç»“æ„çš„å˜é‡èµ‹å€¼ç»™å…¶ä»–å˜é‡ï¼Œ**é”çš„çŠ¶æ€ä¼šè¢«å¤åˆ¶**

```go
func main() {
	var mux sync.Mutex
	var wg sync.WaitGroup
	defer mux.Unlock()
	mux.Lock()
	wg.Add(1)
	go func(mux sync.Mutex) {
		defer func() {
			mux.Unlock()
			wg.Done()
		}()
		mux.Lock() // deadlock
	}(mux)
	wg.Wait()
}
```



### channel

ç®€å•åœ°è¯´ï¼Œchannelå°±æ˜¯**æ”¶å‘æ•°æ®çš„é€šé“**

å£°æ˜ä¸€ä¸ªchannelè¦ä½¿ç”¨`make`å‡½æ•°è¿›è¡Œ**åˆå§‹åŒ–**ï¼Œå¦åˆ™å£°æ˜å‡ºæ¥çš„channelä¸º`nil`

```go
var ch chan int
var ch [size]chan int

ch = make(chan int, size)
```

#### å¸¸è§çš„ä½¿ç”¨æ–¹æ³•

ğŸ•ï¼š

```go
ch <- 1 // å†™å…¥ä¸€ä¸ªæ•°æ®
v := <-ch // è¯»å–ä¸€ä¸ªæ•°æ®
```

âš ï¸ï¼šå¦‚æœchannelæ²¡æœ‰ç¼“å†²åŒºï¼Œé‚£ä¹ˆå†™æ•°æ®å’Œè¯»æ•°æ®å¿…å®šæ˜¯æˆå¯¹å‡ºç°çš„

```go
close(ch) // å…³é—­é€šé“
```

å½“å…³é—­é€šé“ä¹‹åï¼Œ**ä¸èƒ½å†å‘é€šé“ä¸­å†™æ•°æ®ï¼Œä½†æ˜¯èƒ½ä»é€šé“ä¸­è¯»æ•°æ®ï¼Œå¦‚æœé€šé“ä¸­è¿˜æœ‰å€¼åˆ™è¯»å‡ºå¯¹åº”çš„å€¼ï¼Œå¦åˆ™è¯»å‡ºé›¶å€¼**

è¿™å°±å¯¼è‡´ä¸€ä¸ªé—®é¢˜ï¼šå½“æˆ‘è¯»å‡ºé›¶å€¼æ—¶ï¼Œæ— æ³•åˆ¤æ–­å‡ºè¿™æ˜¯å› ä¸º**é€šé“å…³é—­è¿˜æ˜¯å†™å…¥çš„å€¼ç¡®ç¡®å®å®å°±æ˜¯é›¶å€¼**

ğŸ•‘ï¼šæ•…éœ€è¦ä½¿ç”¨é€šé“çš„**åˆ¤å®šè¯»æ³•**ï¼š

```go
val, ok := <-ch
if ok {
    fmt.Printf("get val %d\n", val)
} else {
    fmt.Println("closed")
}
```

å½“ç®¡é“å…³é—­ä¸”è¯»å–å®Œæ¯•åï¼Œokä¸º`false`

ğŸ•’ï¼šæœ‰çš„æ—¶å€™æŸä¸€ä¸ªgoroutineéœ€è¦ä¸€ç›´ç›‘å¬ç€ç®¡é“ä¸­çš„æ•°æ®ï¼Œåªè¦ç®¡é“ä¸­æœ‰æ•°æ®å°±ç«‹é©¬è¯»å–å‡ºæ¥ï¼Œç›´è‡³ç®¡é“å…³é—­

åœ¨Goä¸­å¯ä»¥ä½¿ç”¨`fro range`åšåˆ°æŒç»­ç›‘å¬ç®¡é“ä¸­çš„æ•°æ®

```go
func main() {
	ch := make(chan int)
	go func() {
		for v := range ch {
			fmt.Println(v)
		}
	}()
	time.Sleep(time.Second)
	ch <- 1
	time.Sleep(time.Second)
	ch <- 2
	close(ch)
	time.Sleep(time.Second)
}
```

### åŒå‘channelå’Œå•å‘channel

channelå¯ä»¥æ ¹æ®å…¶åŠŸèƒ½åˆ’åˆ†ä¸º**åŒå‘channelå’Œå•å‘channel**ï¼Œå…¶ä¸­åŒå‘channelæ—¢å¯ä»¥è¯»åˆå¯ä»¥å†™ï¼Œè€Œå•å‘channelè¦ä¹ˆåªè¯»ï¼Œè¦ä¹ˆåªå†™

å¯ä»¥é€šè¿‡**ç±»å‹åˆ«å**çš„æ–¹å¼å®šä¹‰å•å‘channel

ğŸŒ°ï¼š

```go
type RChannel = <-chan int
type WChannel = chan<- int

func main() {
	ch := make(chan int)
	go func() {
		var w WChannel
		w = ch
		w <- 1
	}()
	go func() {
		var r RChannel
		r = ch
		fmt.Println(<-r)
	}()
	time.Sleep(time.Second)
}
```

### æœ‰ç¼“å†²channelå’Œæ— ç¼“å†²channel

æ— ç¼“å†²channelå¯ä»¥ç†è§£ä¸ºæ˜¯**åŒæ­¥æ¨¡å¼**ï¼Œå³ä¸€ä¸ªå†™ï¼Œå¦ä¸€ä¸ªç«‹é©¬è¯»ï¼Œå¦‚æœæ²¡æœ‰è¯»è€…ï¼Œå†™è€…ä¹Ÿä¼šè¢«é˜»å¡

æœ‰ç¼“å†²channelåˆ™å¯ä»¥ä½œä¸º**å¼‚æ­¥æ¨¡å¼**ï¼Œåœ¨ç¼“å†²åŒºæœªæ»¡çš„æƒ…å†µä¸‹ï¼Œå³ä½¿æ²¡æœ‰è¯»è€…ï¼Œå†™è€…ä¹Ÿèƒ½å‘é€šé“ä¸­å†™å…¥æ•°æ®

ä½†å½“ç¼“å†²åŒºæ»¡äº†åï¼Œå†™è€…æƒ³è¦ç»§ç»­å†™å…¥æ•°æ®åˆ™ä¼šè¢«é˜»å¡ï¼Œé€€åŒ–æˆ**åŒæ­¥æ¨¡å¼**

### æ€»ç»“

- å…³é—­ä¸€ä¸ªæœªåˆå§‹åŒ–çš„channelä¼šäº§ç”Ÿpanic
- channelåªèƒ½å…³é—­ä¸€æ¬¡ï¼Œå¯¹åŒä¸€channelå¤šæ¬¡å…³é—­ä¼šå‘ç”Ÿpanic
- å‘ä¸€ä¸ªå·²ç»å…³é—­çš„channelå†™å…¥æ•°æ®ï¼Œä¼šå‘ç”Ÿpanic
- ä»ä¸€ä¸ªå·²ç»å…³é—­çš„channelè¯»å–æ•°æ®ï¼Œä¼šè¯»å‡ºç¼“å†²åŒºä¸­çš„å€¼ï¼Œå½“ç¼“å†²åŒºæ²¡æœ‰æ•°æ®ï¼ˆæˆ–æ²¡æœ‰ç¼“å†²åŒºï¼‰æ—¶ï¼Œåˆ™ä¼šè¯»å‡ºå¯¹åº”ç±»å‹çš„é›¶å€¼
- channelçš„è¯»ç«¯å’Œå†™ç«¯éƒ½å¯ä»¥ç”±å¤šä¸ªgoroutineæ“ä½œï¼Œå½“å†™ç«¯è¢«ä¸€ä¸ªgoroutineå…³é—­æ—¶ï¼Œè¯»ç«¯çš„å¤šä¸ªgoroutineéƒ½ä¼šæ”¶åˆ°ç®¡é“å…³é—­çš„æ¶ˆæ¯
- channelæ˜¯å¹¶å‘å®‰å…¨çš„
