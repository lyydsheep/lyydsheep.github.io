<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>lyydsheep</title>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="keywords" content="">
  <meta name="theme-color" content="#10b981">

  <link rel="canonical" href="http://example.com/2025/01/04/Kafka%E7%90%86%E8%AE%BA%E7%9F%A5%E8%AF%86/">

  <link rel="shortcut icon" href="/">

  
  
<link rel="stylesheet" href="/css/main.css">


  
  <meta name="description" content="整体架构宏观上可以将Kafka分成三个部分：生产者、中间服务层、消费者中间服务层相当于一个“消息中转站”，但不同之处在于，中间服务层会将消息持久化存储 中间服务层由多个部件构成：  broker：可以理解为是一个节点，即运行Kafka程序的服务器 topic：对消息进行逻辑分类的粗粒度单位，可用于实现负载均衡、消息并行处理。消费者订阅某一个主题进行消费。生产者向指定的主题写入消息 partitio">
<meta property="og:type" content="article">
<meta property="og:title" content="lyydsheep">
<meta property="og:url" content="http://example.com/2025/01/04/Kafka%E7%90%86%E8%AE%BA%E7%9F%A5%E8%AF%86/index.html">
<meta property="og:site_name" content="lyydsheep">
<meta property="og:description" content="整体架构宏观上可以将Kafka分成三个部分：生产者、中间服务层、消费者中间服务层相当于一个“消息中转站”，但不同之处在于，中间服务层会将消息持久化存储 中间服务层由多个部件构成：  broker：可以理解为是一个节点，即运行Kafka程序的服务器 topic：对消息进行逻辑分类的粗粒度单位，可用于实现负载均衡、消息并行处理。消费者订阅某一个主题进行消费。生产者向指定的主题写入消息 partitio">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://raw.githubusercontent.com/lyydsheep/pic/main/20250104150207.png">
<meta property="og:image" content="https://raw.githubusercontent.com/lyydsheep/pic/main/20250104192916.png">
<meta property="og:image" content="https://raw.githubusercontent.com/lyydsheep/pic/main/20250105102410.png">
<meta property="og:image" content="https://raw.githubusercontent.com/lyydsheep/pic/main/20250105141657.png">
<meta property="og:image" content="https://raw.githubusercontent.com/lyydsheep/pic/main/20250105144221.png">
<meta property="og:image" content="https://raw.githubusercontent.com/lyydsheep/pic/main/20250105150142.png">
<meta property="article:published_time" content="2025-01-04T06:32:27.252Z">
<meta property="article:modified_time" content="2025-01-05T11:56:39.329Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/lyydsheep/pic/main/20250104150207.png">

  <style>
    :root {
      --sea-color-primary: #10b981;
    }
  </style>

  
<script src="/js/theme_mode.js"></script>

<meta name="generator" content="Hexo 7.3.0"></head>
<body>
  <header class="sea-header">
    <nav class="sea-nav-wrap">
  <h1 class="sea-nav-logo" title="">
    <a href="/">lyydsheep</a>
  </h1>
  <div class="sea-nav-menus">
    <div id="sea-nav-toggle">
      <svg t="1716965724278" class="sea-svg-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="10878" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><path d="M950.857143 768v73.142857c0 20.004571-16.566857 36.571429-36.571429 36.571429H109.714286c-20.004571 0-36.571429-16.566857-36.571429-36.571429v-73.142857c0-20.004571 16.566857-36.571429 36.571429-36.571429h804.571428c20.004571 0 36.571429 16.566857 36.571429 36.571429z m0-292.571429v73.142858c0 20.004571-16.566857 36.571429-36.571429 36.571428H109.714286c-20.004571 0-36.571429-16.566857-36.571429-36.571428v-73.142858c0-20.004571 16.566857-36.571429 36.571429-36.571428h804.571428c20.004571 0 36.571429 16.566857 36.571429 36.571428z m0-292.571428v73.142857c0 20.004571-16.566857 36.571429-36.571429 36.571429H109.714286c-20.004571 0-36.571429-16.566857-36.571429-36.571429V182.857143c0-20.004571 16.566857-36.571429 36.571429-36.571429h804.571428c20.004571 0 36.571429 16.566857 36.571429 36.571429z" p-id="10879"></path></svg>
    </div>

    <div class="sea-menu-wrap">
  

  <span class="sea-menu-sep">|</span>

  

  <span class="sea-menu-icon" id="sea-theme-dark">
    <svg t="1725413107294" class="sea-svg-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="10118" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><path d="M557.553778 976.355556c-257.265778 0-466.56-207.160889-466.56-464.426667 0-253.923556 206.577778-464.284444 460.501333-464.284445h0.355556c10.766222 0 20.622222 3.953778 25.443555 13.610667 4.878222 9.756444 3.740444 20.394667-2.915555 29.027556-55.722667 72.220444-85.162667 158.108444-85.162667 249.372444 0 225.891556 183.779556 409.386667 409.671111 409.386667l5.248-0.256c10.325333-0.142222 20.977778 5.859556 25.841778 15.644444a28.302222 28.302222 0 0 1-2.915556 30.051556C837.902222 910.08 703.203556 976.355556 557.553778 976.355556zM495.274667 105.016889C299.192889 135.281778 147.882667 306.161778 147.882667 509.809778c0 225.877333 183.779556 409.656889 409.671111 409.656889 108.686222 0 210.403556-42.055111 286.577778-116.977778-231.566222-27.192889-411.804444-224.625778-411.804445-463.36 0-83.427556 21.617778-163.299556 62.947556-234.112z" fill="" p-id="10119"></path><path d="M578.830222 879.132444c-186.865778 0-345.784889-133.418667-377.841778-317.269333a14.222222 14.222222 0 1 1 28.017778-4.878222c29.681778 170.183111 176.810667 293.703111 349.824 293.703111a14.222222 14.222222 0 1 1 0 28.444444zM209.991111 531.2c-7.537778 0-13.838222-6.997333-14.193778-14.606222-0.312889-6.584889-0.483556-13.795556-0.483555-20.465778 0-7.864889 6.357333-14.492444 14.222222-14.492444s14.222222 6.229333 14.222222 14.094222c0 6.229333 0.170667 13.425778 0.455111 19.584 0.369778 7.850667-5.674667 15.886222-13.525333 15.886222h-0.696889z" fill="" p-id="10120"></path><path d="M622.350222 309.930667m-25.344 0a25.344 25.344 0 1 0 50.688 0 25.344 25.344 0 1 0-50.688 0Z" fill="" p-id="10121"></path><path d="M787.072 188.273778m-25.344 0a25.344 25.344 0 1 0 50.688 0 25.344 25.344 0 1 0-50.688 0Z" fill="" p-id="10122"></path><path d="M731.960889 415.303111m-25.344 0a25.344 25.344 0 1 0 50.688 0 25.344 25.344 0 1 0-50.688 0Z" p-id="10123"></path></svg>
  </span>
  <span class="sea-menu-icon" id="sea-theme-light">
    <svg t="1725410359322" class="sea-svg-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4274" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><path d="M512 768c-141.376 0-256-114.624-256-256s114.624-256 256-256 256 114.624 256 256-114.624 256-256 256z m0-85.333333a170.666667 170.666667 0 1 0 0-341.333334 170.666667 170.666667 0 0 0 0 341.333334zM469.333333 85.333333a42.666667 42.666667 0 1 1 85.333334 0v85.333334a42.666667 42.666667 0 1 1-85.333334 0V85.333333z m0 768a42.666667 42.666667 0 1 1 85.333334 0v85.333334a42.666667 42.666667 0 1 1-85.333334 0v-85.333334zM85.333333 554.666667a42.666667 42.666667 0 1 1 0-85.333334h85.333334a42.666667 42.666667 0 1 1 0 85.333334H85.333333z m768 0a42.666667 42.666667 0 1 1 0-85.333334h85.333334a42.666667 42.666667 0 1 1 0 85.333334h-85.333334zM161.834667 222.165333a42.666667 42.666667 0 0 1 60.330666-60.330666l64 64a42.666667 42.666667 0 0 1-60.330666 60.330666l-64-64z m576 576a42.666667 42.666667 0 0 1 60.330666-60.330666l64 64a42.666667 42.666667 0 0 1-60.330666 60.330666l-64-64z m-515.669334 64a42.666667 42.666667 0 0 1-60.330666-60.330666l64-64a42.666667 42.666667 0 0 1 60.330666 60.330666l-64 64z m576-576a42.666667 42.666667 0 0 1-60.330666-60.330666l64-64a42.666667 42.666667 0 0 1 60.330666 60.330666l-64 64z" p-id="4275"></path></svg>
  </span>

  <span id="sea-menu-close-icon">
    <svg t="1725435896874" class="sea-svg-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4408" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><path d="M556.8 512l265.6-265.6c12.8-12.8 12.8-32 0-44.8s-32-12.8-44.8 0L512 467.2 246.4 201.6c-12.8-12.8-32-12.8-44.8 0s-12.8 32 0 44.8l265.6 265.6-265.6 265.6c-12.8 12.8-12.8 32 0 44.8 6.4 6.4 12.8 9.6 22.4 9.6s16-3.2 22.4-9.6l265.6-265.6 265.6 265.6c6.4 6.4 16 9.6 22.4 9.6s16-3.2 22.4-9.6c12.8-12.8 12.8-32 0-44.8L556.8 512z" p-id="4409"></path></svg>
  </span>
</div>
<div id="sea-nav-dimmer"></div>
  </div>
</nav>
  </header>
  <main id="sea-main-wrapper">
    <article class="sea-page-card-wrapper">
  <header class="sea-article-header">
    <h1 class="sea-article-title"></h1>
    
      <div class="sea-post-meta sea-post-meta__center">
        <div class="sea-post-time">
  <svg t="1716964550804" class="sea-svg-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2621" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><path d="M805.49888 981.49888l-602.3168-0.76288c-86.59456-8.192-154.56768-81.3056-154.56768-170.01472L48.6144 291.73248c0-94.1568 76.60032-170.75712 170.7776-170.75712l586.10176 0c94.1568 0 170.73152 76.60032 170.73152 170.75712L976.22528 810.7008C976.2304 904.87296 899.63008 981.49888 805.49888 981.49888L805.49888 981.49888zM219.3664 190.57152c-55.79776 0-101.20192 45.38368-101.20192 101.18144l0 518.96832c0 55.79776 45.40416 101.20704 101.20192 101.20704l586.13248 0c55.77728 0 101.16096-45.40928 101.16096-101.20704L906.65984 291.73248c0-55.79776-45.38368-101.18656-101.16096-101.18656L219.3664 190.54592 219.3664 190.57152zM698.84416 290.51904c-25.60512 0-46.38208-20.77696-46.38208-46.38208l0-158.6688c0-25.6 20.77696-46.38208 46.38208-46.38208 25.6 0 46.38208 20.78208 46.38208 46.38208L745.22624 244.1216C745.22624 269.7472 724.46976 290.51904 698.84416 290.51904L698.84416 290.51904zM315.65824 290.51904c-25.60512 0-46.38208-20.77696-46.38208-46.38208l0-158.6688c0-25.6 20.77696-46.38208 46.38208-46.38208 25.6 0 46.38208 20.78208 46.38208 46.38208L362.04032 244.1216C362.04032 269.7472 341.28896 290.51904 315.65824 290.51904L315.65824 290.51904zM534.8864 794.78784l-44.27264 0c-25.6 0-46.38208-20.77696-46.38208-46.38208 0-25.6 20.78208-46.38208 46.38208-46.38208l44.27264 0c25.6 0 46.38208 20.78208 46.38208 46.38208C581.26848 774.01088 560.4864 794.78784 534.8864 794.78784L534.8864 794.78784zM930.79552 452.608 121.24672 452.608c-25.60512 0-46.38208-20.78208-46.38208-46.38208 0-25.60512 20.77696-46.38208 46.38208-46.38208l809.5744 0c25.6 0 46.38208 20.77696 46.38208 46.38208C977.2032 431.82592 956.42624 452.608 930.79552 452.608L930.79552 452.608zM327.92576 649.03168l-44.27264 0c-25.6 0-46.38208-20.78208-46.38208-46.38208 0-25.60512 20.78208-46.38208 46.38208-46.38208l44.27264 0c25.6 0 46.38208 20.77696 46.38208 46.38208C374.30784 628.25472 353.52576 649.03168 327.92576 649.03168L327.92576 649.03168zM534.8864 649.03168l-44.27264 0c-25.6 0-46.38208-20.78208-46.38208-46.38208 0-25.60512 20.78208-46.38208 46.38208-46.38208l44.27264 0c25.6 0 46.38208 20.77696 46.38208 46.38208S560.4864 649.03168 534.8864 649.03168L534.8864 649.03168zM741.27872 649.03168l-44.26752 0c-25.60512 0-46.38208-20.78208-46.38208-46.38208 0-25.60512 20.77696-46.38208 46.38208-46.38208l44.26752 0c25.60512 0 46.38208 20.77696 46.38208 46.38208C787.6608 628.25472 766.90944 649.03168 741.27872 649.03168L741.27872 649.03168zM327.92576 794.78784l-44.27264 0c-25.6 0-46.38208-20.77696-46.38208-46.38208 0-25.6 20.78208-46.38208 46.38208-46.38208l44.27264 0c25.6 0 46.38208 20.78208 46.38208 46.38208C374.30784 774.01088 353.52576 794.78784 327.92576 794.78784L327.92576 794.78784zM741.27872 794.78784l-44.26752 0c-25.60512 0-46.38208-20.77696-46.38208-46.38208 0-25.6 20.77696-46.38208 46.38208-46.38208l44.26752 0c25.60512 0 46.38208 20.78208 46.38208 46.38208C787.6608 774.01088 766.90944 794.78784 741.27872 794.78784L741.27872 794.78784z" p-id="2622"></path></svg>
  <time datetime="2025-01-04T06:32:27.252Z">2025-01-04</time>
</div>
        
        
      </div>
    
  </header>
  <div class="sea-doc">
    
    
      <div class="sea-article-catalog">
        <h2>Table of contents</h2>
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84"><span class="toc-number">1.</span> <span class="toc-text">整体架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Topic"><span class="toc-number">2.</span> <span class="toc-text">Topic</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Partition"><span class="toc-number">3.</span> <span class="toc-text">Partition</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Broker"><span class="toc-number">4.</span> <span class="toc-text">Broker</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E8%80%85Producer"><span class="toc-number">5.</span> <span class="toc-text">生产者Producer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85Consumer"><span class="toc-number">6.</span> <span class="toc-text">消费者Consumer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Rebalance%E6%9C%BA%E5%88%B6"><span class="toc-number">7.</span> <span class="toc-text">Rebalance机制</span></a></li></ol>
      </div>
    
    <div class="sea-article-content">
      <h2 id="整体架构"><a href="#整体架构" class="headerlink" title="整体架构"></a>整体架构</h2><p>宏观上可以将Kafka分成三个部分：生产者、中间服务层、消费者<br>中间服务层相当于一个“消息中转站”，但不同之处在于，中间服务层会将消息持久化存储</p>
<p>中间服务层由多个部件构成：</p>
<ul>
<li>broker：可以理解为是一个节点，即运行Kafka程序的服务器</li>
<li>topic：对消息进行逻辑分类的粗粒度单位，可用于实现负载均衡、消息并行处理。消费者订阅某一个主题进行消费。生产者向指定的主题写入消息</li>
<li>partition：消息上物理上存储的空间，一个partition对应着一个topic，一个topic可以有多个partition。partition对于生产者和消费者是透明的、无法感知的。<ul>
<li>每个partition存储着有序、不可变的消息序列</li>
<li>partition可被独立读写</li>
</ul>
</li>
</ul>
<p>broker、topic、partition三者之间的关系如下：</p>
<p><img src="https://raw.githubusercontent.com/lyydsheep/pic/main/20250104150207.png" alt="image.png"></p>
<h2 id="Topic"><a href="#Topic" class="headerlink" title="Topic"></a>Topic</h2><p>在Kafka中，Topic就是一个主题，属于逻辑上的概念，并不存在任何一台物理设备上。作为使用者，我们可以将同业务的消息放入同一个topic，例如秒杀业务、售票业务等，通过这个逻辑上的概念，可以粗粒度地将数据消息进行分片，分门别类地处理消息。</p>
<h2 id="Partition"><a href="#Partition" class="headerlink" title="Partition"></a>Partition</h2><p>对数据进行逻辑Topic分区后，一个业务的数据量可能仍然庞大，为了对数据进一步分而治之，设计Kafka的大佬决定将Topic的数据实际物理存储在一个个Partition中。Partition就相当于对粗粒度划分的数据再进行一次细粒度区分。由于Topic是一个逻辑上的概念，并不存在于某一个具体的broker上，因此在集群模式下，同一个Topic下的多个Partition是独立的，完全可以在不同的broker上。</p>
<p>分片的好处：</p>
<ul>
<li>提高写入性能，不同的partition分布在不同的broker上，可以实现并行写入，提高了系统吞吐量</li>
<li>提高消费者并发度，因为有了不同的分片，不同的消费者可以对不同的分片同时消费</li>
<li>提高了Kafka水平扩展能力</li>
<li>提高了系统的容错能力，引入partition后，同一个 Topic下不同partition中的数据解耦合，即使一个partition崩溃了，也不影响其他partition运作</li>
</ul>
<p>一个Partition就相当于一个队列，最新的数据被写在队列的末尾，即同一个Partition下的数据是有序的，但综合来看，同一个Topic下的所有Partition中的数据是无序的<br><img src="https://raw.githubusercontent.com/lyydsheep/pic/main/20250104192916.png" alt="image.png"></p>
<p>由于Partition对于生产者是透明的，那么生产者向一个Topic写入数据，数据最终会流向何处呢？<br>如果生产者向Topic发送消息时没有指定Key，那么Kafka服务就会默认采取<strong>轮询Partition</strong>的方式将数据写入到Partition中。<br>如果生产者指定了发送的Key，那么消息就会被写入到将Key进行哈希过后对应的Partition中</p>
<h2 id="Broker"><a href="#Broker" class="headerlink" title="Broker"></a>Broker</h2><p>Broker实际就是一个运行Kafka程序的服务器节点，Broker需要提供如下功能：</p>
<ol>
<li>接受来自客户端的连接</li>
<li>支持客户端查询Kafka集群的信息，比如查询其他Broker信息</li>
<li>响应来自客户端的命令请求</li>
<li>存储消息，即将消息持久化存储在本地服务器上</li>
</ol>
<p>在集群部署模式下，每一个Broker都有唯一的ID标识自己身份。Partition是存放在Broker节点上的，一个Partition对应一个Broker，一个Broker可能存放着多个Partition<br>针对于一个Topic下的多个Partition，需要先随机选取一个Broker（比如是Broker10）存放Partition_0，接着按照Broker的ID顺序依次存放Partition，即Broker11存放Partition_1、Broker12存放Partition_2，以此类推。</p>
<p>前文提及了，消费者在发送消息时可以指定Key，相当于将消息发送到指定的Partition上。那么客户端是如何在Kafka集群中快速找到目标Partition所在的Broker节点呢？<br>通常客户端连接集群有三种方式：</p>
<ol>
<li>引入代理，代理和众多Broker打交道</li>
<li>重定向，客户端发送命令到某一个节点上，如果该节点不是目标节点，那么该节点会告知客户端木笔哦节点具体地址（Redis）</li>
<li>查询路由表，客户端先查询路由表，直接向目标节点发送请求命令（Kafka）</li>
</ol>
<p>Kafka选择第三种方式的一个契机是，在Kafka集群中，每一个Broker都支持客户端查询Kafka集群的信息，即每一个Broker都知晓其他Broker的信息。这些信息都被维护在每一个Broker的路由表中，了解了这一点，客户端发送读写命令的过程就呼之欲出了：</p>
<ol>
<li>任意访问一台Broker</li>
<li>从这台Broker中获取路由表</li>
<li>根据规则找到目标Partition，在路由表中找到哪个Broker上存有目标Partition，最后发送读写命令<ol>
<li>找Partition的规则就是上文讲的<strong>轮询或哈希Key</strong>规则</li>
</ol>
</li>
</ol>
<h2 id="生产者Producer"><a href="#生产者Producer" class="headerlink" title="生产者Producer"></a>生产者Producer</h2><p>生产者发送一条消息需要历经三个步骤：</p>
<ul>
<li>构建消息：将需要发送的信息打包成Kafka消息结构</li>
<li>序列化消息：将消息序列化成二进制数据，以便在网络中传输</li>
<li>寻找Broker：根据规则找到目标分区，接着依据路由表将消息发送到Partition对应的Broker</li>
</ul>
<p><strong>构建消息</strong><br>生产者需要将发送的信息打包成Kafka消息结构，接下来就详细看看消息结构的具体组成：<br><img src="https://raw.githubusercontent.com/lyydsheep/pic/main/20250105102410.png" alt="image.png"></p>
<ul>
<li>Key：根据Key的哈希值（取模）确定发送到Topic下的哪一个Partition上，一般是字符串类型，最终会被序列化为二进制数据</li>
<li>Value：实际发送的数据</li>
<li>Compression Type：指定压缩算法，该字段表明采用什么压缩算法对数据进行压缩，枚举值：None、gzip、lz4等</li>
<li>Header：生产者额外想传输的数据就放在Header中，比如TraceID</li>
<li>Partition+Offset：该字段在生产出来的时候是空的，消息发送到Kafka服务端后才会将具体的分区、偏移量写入该字段。Topic + Partition + Offset唯一确定一条消息</li>
</ul>
<p><strong>序列化</strong><br>序列化就是将消息从常规类型转换至二进制类型，以在网络中传输</p>
<p><strong>发送模式</strong><br>在Go、Java的SDK中提供了三种消息发送模式：</p>
<ol>
<li>同步发送，生产者发送消息后，执行阻塞操作，等待Kafka服务端返回发送消息成功或异常结果。适用于生产者需要确保成功发送消息才能执行后续操作的场景。</li>
<li>发了就忘，生产者发完消息就继续执行后续操作，不理会消息是否发送成功，也不采取措施应对发送异常</li>
<li>异步发送，生产者发送消息的同时注册回调函数，不执行阻塞操作，而是继续执行后续的操作。当Kafka服务端返回发送消息的结果后，执行对应回调函数的内容</li>
</ol>
<p>三种发送模式实际上就是<strong>高性能和可靠性</strong>之间的权衡。同步发送模式可靠性强，但是效率不高，适用于保持数据一致性的场景；发了就忘性能高，可是不保证可靠性，因此适合在要求高性能的场景下使用；异步发送就是在二者之间的折中办法，使用于在需要时处理消息发送失败的情况</p>
<h2 id="消费者Consumer"><a href="#消费者Consumer" class="headerlink" title="消费者Consumer"></a>消费者Consumer</h2><p>和生产者一样，消费者也需要集成Kafka客户端库，通过接口向Broker获取消息进行消费<br><img src="https://raw.githubusercontent.com/lyydsheep/pic/main/20250105141657.png" alt="image.png"><br>通过上图可得出一下结论：</p>
<ol>
<li>不同的消费者可以在同一时刻对同一Topic进行消费</li>
<li>一个消费者可以在同一时刻对一个Topic下的不同Partition进行消费</li>
<li>一个消费者同时消费多个Partition是无法保证消息有序性的</li>
<li>一个消费者只消费一个Partition，消费顺序即生产顺序，是有序的</li>
</ol>
<p><strong>拉还是推</strong>？<br>消费者消费消息是通过<strong>拉模式</strong>进行的，也就是说，消费者先向Broker发送拉取消息的信号，接着Broker再将消息发送给消费者，而不是Broker主动向消费者推送消息。<br>选择这种拉模式的主要原因在于，消费者可以根据自身的资源利用率（CPU、内存等）适时地向Broker拉取消息，调节消费速度，避免因消费速度不合适导致资源浪费或超载</p>
<p><strong>消费者Offset</strong><br>在Partition中，位于Offset之前的消息都已经被消费过了，而之后的消息则没有被消费。消费者组每消费完一个消息后，就向Broker提供该消息的Offset，表示该消息已经消费过了。消费者下一次拉取的消息就是Partition中Offset的下一位。消费者完成消费后，就将该消息的“Partition + Offset”字段信息发送给Broker，由Broker负责更新对应Partition的Offset<br><img src="https://raw.githubusercontent.com/lyydsheep/pic/main/20250105144221.png" alt="image.png"></p>
<p><strong>主动提交和被动提交</strong><br>消费者组提交Offset分为两种方式：</p>
<ul>
<li>被动提交</li>
<li>主动提交<br>被动提交就是定时周期性地向Broker提交最新已处理的消息。但是这种提交方式存在一致性问题，例如消费者正在处理offset为5的消息，此时发生了被动提交，需要告知Broker将Offset更新为5，但实际上offset为5的消息还没有完全处理完。如果此时发生了崩溃重启，那么该消息就会被丢失。</li>
</ul>
<p>手动提交则是一种更为稳妥的方式，当某条消息彻底处理好后，再主动向Broker提交消息，避免出现不一致的情况。<br><img src="https://raw.githubusercontent.com/lyydsheep/pic/main/20250105150142.png" alt="image.png"></p>
<p><strong>消费者组ConsumerGroup</strong><br>消费者组实质就是由多个消费者组成的集合，一个消费者组由一个GroupID唯一标识。<br>多个消费者组成消费者组，那么这些消费者必须有一些约束：</p>
<ul>
<li>在同一个消费者组中，一个Partition只能分配一个消费者</li>
<li>同一个消费者组中，可以分派多个消费者</li>
<li>不同消费者组可以同时消费同一个Topic<br>消费者组在消费者方面进行了水平扩容，提高了消费能力。</li>
</ul>
<p>消费者组咋眼一看没多大用处，实际上，消费者组带来的最大便利在于对分区的封装性，一个消费者组可以自动完成<strong>Re balance</strong>操作，使得Partition对于消费者是透明的。反之，消费者每次拉取消息都要指定Partition，这就导致Partition和消费者耦合在一块，Partition数量发生变动，消费者方面的代码就要随之变动</p>
<p><strong>消费者组分区分配策略</strong><br> partition.assignment.strategy字段可以配置消费者组中多个消费者对于分区分配的规则：</p>
<ul>
<li>Range Assignor：基于范围的分配策略</li>
<li>Round Robin Assignor：基于轮询的分配策略</li>
<li>Sticky Assignor：优先保持当前的分配状态，尽量减少Rebalance过程中分区的移动</li>
<li>CooperativeSticky Assignor：基本和Sticky Assignor策略一致，但是区别在于该协议将原来一次行对一大片分区进行Rebalance改为多次小规模的Rebalance操作，即渐进式Rebalance</li>
</ul>
<h2 id="Rebalance机制"><a href="#Rebalance机制" class="headerlink" title="Rebalance机制"></a>Rebalance机制</h2><p> Rebalance机制用于确保数据在消费者组中尽可能地负载均衡<br> 触发Rebalance的三个时机：</p>
<ul>
<li>加入新的消费者</li>
<li>消费者减少，不论是正常关闭还是崩溃</li>
<li>Topic下的Partition数量发生变化</li>
</ul>
<p><strong>再平衡的步骤</strong><br>再平衡操作需要经历五个阶段：</p>
<ol>
<li>暂停消费，消费者需要暂停正在进行的消费，防止重新分配过程中出现数据丢失或重复问题</li>
<li>触发再分配，由消费者组协调器Group Coordinator（通常是一个Broker）触发再平衡</li>
<li>分配分区，消费者配合协调器根据当前消费者和分区数量，重新分配主题的分区</li>
<li>获取分配信息，重新分配完成后，消费者会从协调器拿到新的分区分配情况</li>
<li>恢复消费，消费者收到新的分配后，恢复消费，开始处理新分区</li>
</ol>
<p>上文提到有四种消费组分区分配策略，这四种分配策略可以依据是否产生STW问题分为Eager和Incremental两种再平衡策略。其中前三种方案都是Eager策略，因为这三种分配策略在暂停消费者阶段会停止所有的消费行为，而Cooperative Sticky方式则只会暂停部分消费者，未被暂停的消费者仍能继续消费行为，但代价是Rebalance的时间被延长</p>
<p><strong>Group Coordinator是什么</strong>？</p>

    </div>
  </div>

  
    
  <div class="sea-prev-next-wrapper">
    
      <div class="prev">
        <span><</span>
        <a class="link" href="/2025/01/12/interview%20experience/%E5%AD%97%E8%8A%82%E8%B7%B3%E5%8A%A8/">
          
        </a>
      </div>
    
    
      <div class="next">
        <a class="link" href="/2024/12/27/%E7%90%86%E7%9D%AC/">
          
        </a>
        <span>></span>
      </div>
    
  </div>

  
</article>


  </main>
  <footer id="sea-footer-container">
  <div class="sea-footer-row">
    <div class="sea-footer-menu-link">
      
    </div>
  </div>
  
  
  <div class="sea-footer-row">
    <div class="sea-footer-copyright">
      <span>©</span>
      
        2025
      
      <span>·</span>
      John Doe
    </div>
    <span class="split-line">|</span>
    <div class="sea-footer-theme-by">
      Theme by <a class="theme" href="https://github.com/hai-zou/hexo-theme-sea" target="_blank">Sea</a>
    </div>
  </div>
</footer>

  
<script src="/js/main.js"></script>


<script src="/js/theme.js"></script>

</body>
</html>